<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-list-page plugin-blog plugin-id-default">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.1">
<title data-rh="true">Zaxro blog! | Zaxro Blog</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://suyuying.github.io/img/githubLogoV1.svg"><meta data-rh="true" name="twitter:image" content="https://suyuying.github.io/img/githubLogoV1.svg"><meta data-rh="true" property="og:url" content="https://suyuying.github.io/blog"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" property="og:title" content="Zaxro blog! | Zaxro Blog"><meta data-rh="true" name="description" content="A blog for recording note of coding and daily life!"><meta data-rh="true" property="og:description" content="A blog for recording note of coding and daily life!"><meta data-rh="true" name="docusaurus_tag" content="blog_posts_list"><meta data-rh="true" name="docsearch:docusaurus_tag" content="blog_posts_list"><link data-rh="true" rel="icon" href="/img/githubLogoV1.svg"><link data-rh="true" rel="canonical" href="https://suyuying.github.io/blog"><link data-rh="true" rel="alternate" href="https://suyuying.github.io/blog" hreflang="en"><link data-rh="true" rel="alternate" href="https://suyuying.github.io/blog" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://H9WLDZ1QEH-dsn.algolia.net" crossorigin="anonymous"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Zaxro Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Zaxro Blog Atom Feed">



<link rel="search" type="application/opensearchdescription+xml" title="Zaxro Blog" href="/opensearch.xml">



<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous">
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC&amp;display=swap"><link rel="stylesheet" href="/assets/css/styles.09b20231.css">
<link rel="preload" href="/assets/js/runtime~main.4f00459b.js" as="script">
<link rel="preload" href="/assets/js/main.f3a13247.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/githubLogoV1.svg" alt="Zaxro" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/githubLogoV1.svg" alt="Zaxro" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">Zaxro</b></a><a class="navbar__item navbar__link" href="/docs/intro">Code Note</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/blog">Daily Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/suyuying" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_pO2u margin-bottom--md">Recent posts</div><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2023/05/15/IaC/Terraform/basic-introuduction-of-Terraform">Basic introduction of Terraform</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2023/05/14/Others/steps-to-resovle-http-status">Steps to resolve web application problem</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2023/05/12/Aws/cloudwatch-cloudtrail">Basic introduction of cloudwatch and  cloudtrail</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2023/05/11/Aws/s3-basic-intro">aws s3 basic introduction and attach iam role to operate s3</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2023/05/10/Others/interview-question">運維,DevOps,SRE常見問題</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><meta itemprop="image" content="https://github.com/suyuying.png"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/blog/2023/05/15/IaC/Terraform/basic-introuduction-of-Terraform">Basic introduction of Terraform</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2023-05-15T00:00:00.000Z" itemprop="datePublished">May 15, 2023</time> · <!-- -->20 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/suyuying" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://github.com/suyuying.png" alt="zaxro"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/suyuying" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">zaxro</span></a></div><small class="avatar__subtitle" itemprop="description">Life is too short to live someone else&#x27;s dream</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>使用 Terraform 首要注意事項</p><ol><li><span style="background-color:#1877F2;border-radius:20px;color:#fff;padding:6px;cursor:pointer">apply 之後看到 destroy 有件數,請立刻停手，並按下中斷,然後去找其他人討論</span></li></ol><h2 class="anchor anchorWithStickyNavbar_LWe7" id="what-is-terraform">What is Terraform?<a href="#what-is-terraform" class="hash-link" aria-label="Direct link to What is Terraform?" title="Direct link to What is Terraform?">​</a></h2><p>HashiCorp 公司打造的 IaC 工具,使用者透過可閱讀的設定檔以達到版控,重複使用,共享設定,管理本地端(on-premises resources)跟雲端(cloud resources)由低階組件,例如:計算、存儲、網路資源,到高層級組件,例如 DNS record,SAAS 功能等的管理.</p><p>基本上,常用的雲服務,他都可以操作,地端機器也可以透過 terraform 管理！他有自己的 config 語言(<!-- -->*<!-- -->tf),透過 tf 檔跟各廠商的 api 做串接,也就是說原本你要創建 instance,要自己去翻 aws 的指令,現在只要知道怎麼設定 tf 檔就好,當 terraform 幫你把東西建立好,會把 response 的資訊寫在一隻 state 檔案！</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="installation">installation<a href="#installation" class="hash-link" aria-label="Direct link to installation" title="Direct link to installation">​</a></h3><p><a href="https://developer.hashicorp.com/terraform/downloads" target="_blank" rel="noopener noreferrer">官網安裝</a>cover 所有用例,以下提供我的 lab 環境的安裝方式,linux centos</p><div class="language-jsx codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-jsx codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">sudo yum install </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">y yum</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">utils</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sudo yum</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">config</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">manager </span><span class="token operator" style="color:#393A34">--</span><span class="token plain">add</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">repo https</span><span class="token operator" style="color:#393A34">:</span><span class="token operator" style="color:#393A34">/</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">rpm</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">releases</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">hashicorp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">com</span><span class="token operator" style="color:#393A34">/</span><span class="token constant" style="color:#36acaa">RHEL</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">hashicorp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">repo</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sudo yum </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">y install terraform</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>因為我這邊 lab 都會用 aws,所以要另外設定 IAM 的相關資訊,請人幫你把你的 key 生出來吧</p><ol><li>set the AWS_ACCESS_KEY_ID</li></ol><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">export AWS_ACCESS_KEY_ID=</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ol start="2"><li>set your secret key.</li></ol><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">export AWS_SECRET_ACCESS_KEY=</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="基本資料型態">基本資料型態<a href="#基本資料型態" class="hash-link" aria-label="Direct link to 基本資料型態" title="Direct link to 基本資料型態">​</a></h3><p>HCL 是 terraform 公司為了提升 config 閱讀性,所開發的配置語言,檔名是<!-- -->*<!-- -->.tf, 專門用於配置和描述基礎設施的狀態跟資源！</p><p>常用的有以下幾種型態的變數,<span style="background-color:#1877F2;border-radius:20px;color:#fff;padding:6px;cursor:pointer">String,List,Map(dict),Number,Boolean.</span>,對寫過程式的人而言,就跟 python 基本型態差不多,以下是他們在 variables.tf 中常用定義方式,為免去大家跟我踩過同樣的坑,強調幾點:</p><ol><li><span style="background-color:#1877F2;border-radius:20px;color:#fff;padding:6px;cursor:pointer">HCL語法String的值無論如何都要加雙引號</span> ,我自己在用 terraform cloud 就有勾 HCL 格式但沒有加雙引號,卡了一個小時Ｑ</li></ol><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># String</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">variable &quot;instance_type&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description = &quot;The type of instance to start.&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type        = string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  default     = &quot;t2.micro&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># List</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">variable &quot;subnet_ids&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description = &quot;A list of subnet IDs to associate with the EC2 instance&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type        = list(string)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  default     = [&quot;subnet-abcde012&quot;, &quot;subnet-bcde012a&quot;, &quot;subnet-fghi345a&quot;]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 如果你需要將屬性組織成一個具有特定類型和約束的實體，則可以使用對象object。如果你需要將鍵映射到值，而不需要特定的屬性約束，則可以使用映射Map。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Map</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">variable &quot;tags&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description = &quot;A map of tags to add to all resources&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type        = map(string)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  default     = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Environment = &quot;Test&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Owner       = &quot;DevOps Team&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># object</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">variable &quot;person&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type = object({</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    name    = string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    age     = number</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    address = string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  })</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  default = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    name    = &quot;John Doe&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    age     = 30</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    address = &quot;123 Main St&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Number</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">variable &quot;max_size&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description = &quot;The maximum size of the autoscale group&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type        = number</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  default     = 5</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Boolean</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">variable &quot;enable_public_ip&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description = &quot;Enable/Disable public IP on the instance&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type        = bool</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  default     = false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="常見基礎結構">常見基礎結構<a href="#常見基礎結構" class="hash-link" aria-label="Direct link to 常見基礎結構" title="Direct link to 常見基礎結構">​</a></h3><ul><li>main.tf：主要的 Terraform 設定檔。通常包含定義基礎設施的 Terraform 資源配置。</li><li>variables.tf：變數定義檔案。這裡定義了 Terraform 使用的變數，例如 AWS 密鑰、資源命名等。這些變數可以在其他檔案中使用，以提供更靈活的配置選項。</li><li>outputs.tf：輸出定義檔案。這裡由使用者定義要 Terraform 輸出的值，例如 IP 位址、URL 或其他資源屬性。這些值可以供其他系統或模組使用,是選擇性的！</li><li>terraform.tfvars：變數值檔案。在這裡可以指定變數的具體值，以供 Terraform 使用。這是一個可選的檔案，可以方便地管理變數的值，避免硬編碼敏感資訊。</li><li>provider.tf：提供者配置檔案。這裡指定了 Terraform 使用的提供者，例如 AWS、Azure、Google Cloud 等。可以在這裡配置提供者的相關認證和設定。</li><li>modules/：模組目錄。這個目錄用於存放自定義的 Terraform 模組。模組是可重用的程式碼塊，用於建立和管理特定類型的基礎設施資源。</li><li>environments/：環境目錄。這個目錄通常用於區分不同環境（例如 dev、staging、prod）的 Terraform 設定。每個環境目錄中可以有自己的 main.tf、variables.tf 和其他相關檔案。</li><li>terraform.state：這個檔案不要做版控,也不要亂 VIM,也不是由使用者產生！主要是 apply 時會產生由 terraform 套件產生！會去比對 <!-- -->*<!-- -->.tf 跟該檔案的區別去建立預計更新規劃。</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="建立-ec2-的小-lab">建立 EC2 的小 LAB<a href="#建立-ec2-的小-lab" class="hash-link" aria-label="Direct link to 建立 EC2 的小 LAB" title="Direct link to 建立 EC2 的小 LAB">​</a></h3><p>這邊的 lab 會建立 vpc,切割 subnet,並建立一台 ec2,並把建立後資訊透過 output.tf 印出,基本上就是<a href="https://developer.hashicorp.com/terraform/tutorials/aws-get-started/infrastructure-as-code" target="_blank" rel="noopener noreferrer">官網教學簡化版</a>.</p><p>建立資料夾</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">mkdir -p learn-terraform-aws-instance</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cd learn-terraform-aws-instance</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>建立以下檔案</p><div class="language-jsx codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">provider.tf</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-jsx codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">terraform </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  required_providers </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    aws </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      source  </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;hashicorp/aws&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      version </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;~&gt; 4.16&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  required_version </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;&gt;= 1.2.0&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>provider.tf 會定義使用的 provider 來源跟版本.這邊指定了使用 hashicorp/aws 提供者的版本 ~&gt; 4.16,代表不能使用 4.17 或任何非 4.16 版本.另外必要的 Terraform 版本為 &gt;= 1.2.0，這意味著需要至少 1.2.0 版本的 Terraform。</p><div class="language-jsx codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">main.tf</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-jsx codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">provider </span><span class="token string" style="color:#e3116c">&quot;aws&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  region  </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;us-west-1&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">data </span><span class="token string" style="color:#e3116c">&quot;aws_ami&quot;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;latest_ami&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  most_recent </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  filter </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    name   </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;name&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    values </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;amzn2-ami-hvm-*&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  filter </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    name   </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;virtualization-type&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    values </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;hvm&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  filter </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    name   </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;root-device-type&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    values </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;ebs&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  owners </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;amazon&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">resource </span><span class="token string" style="color:#e3116c">&quot;aws_vpc&quot;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;example&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  cidr_block </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;10.0.0.0/16&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">resource </span><span class="token string" style="color:#e3116c">&quot;aws_subnet&quot;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;example_subnet&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  vpc_id            </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> aws_vpc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">example</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">id</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  availability_zone </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;us-west-1a&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  cidr_block        </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;10.0.0.0/24&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">resource </span><span class="token string" style="color:#e3116c">&quot;aws_instance&quot;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;app_server&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ami           </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> data</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">aws_ami</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">latest_ami</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">id</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  instance_type </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;t2.micro&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  subnet_id     </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> aws_subnet</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">example_subnet</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">id</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  tags </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token maybe-class-name">Name</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;ExampleAppServerInstance&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>main.tf 會定義資源狀態,這邊值的帶入可以用變數也可以用固定寫死的,以下講解各 block 做的事！</p><ol><li><p>provider 區塊:與特定基礎設施平台（如 AWS、Azure、GCP）進行交互的插件,首先以 provider &quot;aws&quot;定義 aws 資源建立區域.</p></li><li><p>data 區塊:查訊資料用,因為懶得上網查詢 us-west-1 的 linux 版 ami,所以使用 data 去區塊查詢最新 ami.</p></li><li><p>resource 區塊:定義資源</p><p>3.1 因為 instance 建置時要選定網段,所以透過 resource &quot;aws_vpc&quot; &quot;example&quot;指定 VPC 網段</p><p>3.2 由 vpc 中進行網段切割,這邊因為是 demo 就不分 public 跟 private 了.public 跟 private 區別在於 public 網段會有 Igw,並透過 aws 發的隨機 public ip 或自己的 Eip 去跟外界做連線,通常用於需要對外連接的資源，例如 Web 伺服器或公開可訪問的應用程式,而 private subnet 則是不會有對外 ip,要連外都是透過 NAT,而跟內部資源會互通,通常用於內部應用程式、資料庫伺服器等不需要直接對外公開的資源。</p><p>3.3 有了網段,就可以用查詢到的 ami_id 跟 subnet 去建立 instance</p></li></ol><p>terraform.tfvars 用來定義變數的值！</p><div class="language-jsx codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">outputs.tf</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-jsx codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">output </span><span class="token string" style="color:#e3116c">&quot;latest_ami_id&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  value </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> data</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">aws_ami</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">latest_ami</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">id</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>outputs.tf 做的事情,要去理解它可能等你 apply 會比較清楚,基本上整個過程會許有多值是使用預設,有些則是查詢出來,有些則是你寫的變數. output 可以把值輸出.</p><p>以下的設定檔是拿來定義變數的,請等 output 出來之後,把 data 槓掉,然後改用變數跟值帶入.不過你也可以試著先帶,但在<code>terraform init</code>會報錯</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">The Terraform configuration must be valid before initialization so that</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Terraform can determine which modules and providers need to be installed.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">╷</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│ Error: Variables not allowed</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   on variables.tf line 2, in variable &quot;ami_id&quot;:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│    2:   default = data.aws_ami.latest_ami.id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│ Variables may not be used here.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="執行指令">執行指令<a href="#執行指令" class="hash-link" aria-label="Direct link to 執行指令" title="Direct link to 執行指令">​</a></h4><p>在上面設定檔完成後,請依序執行</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">terraform init</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>init 功能是安裝 module,因為是首次建立 module,所以會發現資料夾多了.terraform 資料夾(放 module) 跟.terraform.lock.hcl(鎖定使用的 module 版號),如果之後有改動版本,要用<code>terraform init -upgrade</code>去更新,不然始終會用同版本！在執行 terraform init -upgrade 之前，請確保已備份您的 Terraform 配置文件和相關的狀態文件</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">terraform fmt</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>fmt : 按規定幫你重新派列格式檔格式</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">terraform validate</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>幫你驗證是否 config 有明顯錯誤,但不代表 vaildate 過了 apply 會過</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">terraform apply</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>在 apply 過程會對設定檔產生 global lock,避免冲突和競爭狀態.接著讀取已產生的 state 檔案(如無就不用比較),並讀取<!-- -->*<!-- -->.tf 檔,比較兩者差異生成一個計劃，顯示要進行的操作和預期的變更。然後，它會要求使用者確認執行計劃。如確認,則會執行資源新增,並把結果狀態存在 terraform.state.
然後,你就會發現你建立三個資源,vpc,subnet,ec2~ 十分方便對吧～要刪除只要執行<code>terraform destroy</code>即可！</p><p>執行完之後,會長這樣</p><div class="language-jsx codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-jsx codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token maybe-class-name">Apply</span><span class="token plain"> complete</span><span class="token operator" style="color:#393A34">!</span><span class="token plain"> </span><span class="token maybe-class-name">Resources</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3</span><span class="token plain"> added</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> changed</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> destroyed</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">Outputs</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">latest_ami_id </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;ami-0ee3e1e65adeef858&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>把查到到 ami_id 做成變數,variables.tf 是拿來定義你有哪些變數,該變數的型態及預設值！</p><div class="language-jsx codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">variables.tf</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-jsx codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">variable </span><span class="token string" style="color:#e3116c">&quot;ami_id&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword module" style="color:#00009f">default</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;ami-0ee3e1e65adeef858&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>因為已經查到 ami_id,接著就到 main.tf 把 data 區塊拿掉, ami_id 改用變數帶入,也就是 var.ami_id</p><div class="language-jsx codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">main.tf</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-jsx codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">provider </span><span class="token string" style="color:#e3116c">&quot;aws&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  region  </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;us-west-1&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">resource </span><span class="token string" style="color:#e3116c">&quot;aws_vpc&quot;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;example&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  cidr_block </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;10.0.0.0/16&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">resource </span><span class="token string" style="color:#e3116c">&quot;aws_subnet&quot;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;example_subnet&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  vpc_id            </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> aws_vpc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">example</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">id</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  availability_zone </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;us-west-1a&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  cidr_block        </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;10.0.0.0/24&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">resource </span><span class="token string" style="color:#e3116c">&quot;aws_instance&quot;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;app_server&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ami           </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">var</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">ami_id</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  instance_type </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;t2.micro&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  subnet_id     </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> aws_subnet</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">example_subnet</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">id</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  tags </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token maybe-class-name">Name</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;ExampleAppServerInstance&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>記得 outputs.tf 也要改</p><div class="language-jsx codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">outputs.tf</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-jsx codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">output </span><span class="token string" style="color:#e3116c">&quot;latest_instance_id&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  value </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> aws_instance</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">app_server</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">id</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-jsx codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">terraform.tfvars</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-jsx codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 之後要換值</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">就改這邊</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">用ami_id </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;ami-xxxxxxxxxxxxxx&quot;</span><span class="token plain">放進來！</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>最後,你寫的 output 區塊,查到的值實際上會被放到 terraform.state 保存,你可以透過 key 並以下方式查詢你在 output 的值.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">terraform output latest_instance_id</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="常用指令">常用指令<a href="#常用指令" class="hash-link" aria-label="Direct link to 常用指令" title="Direct link to 常用指令">​</a></h3><ul><li><p><code>terraform init</code>: 初始化 Terraform 工作目錄，下載所需的提供者插件並設定工作目錄,會產生.terraform 資料夾,底下會放 module 資料,另外會產生.terraform.lock.hcl 去鎖定你執行的 module 版本.</p></li><li><p><code>terraform plan</code>: 檢視 Terraform 的執行計劃，查看預期的變更。</p></li></ul><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">terraform plan -out=tfplan # 執行 terraform plan 並將計畫保存到一個檔案中</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">terraform show -json tfplan &gt; plan.json #使用 terraform show -json 命令將計畫檔案轉換為 JSON 格式</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li><code>terraform apply</code>: 執行 Terraform 的執行計劃，建立或修改基礎設施。</li><li><code>terraform plan --refresh-only</code>- 讓你可以先檢視目前真實的資源狀態,跟你的 terraform.state 狀態檔差異,並決定是否 renew 狀態檔</li><li><code>terraform apply --refresh-only</code>-讓你可以先檢視目前真實的資源狀態,跟你的 terraform.state 狀態檔差異,並決定是否 renew 狀態檔</li><li><code>terraform refresh</code>:請少用！他會直接更新你的 state 狀態檔,風險在於你根本不知道改變了什麼,建議用 <code>terraform apply --refresh-only</code><div class="theme-admonition theme-admonition-info alert alert--info admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_S0QG"><p>如果想看<code>terraform refresh</code>跟<code>terraform apply --refresh-only</code>詳細差異,要看<a href="https://developer.hashicorp.com/terraform/tutorials/state/refresh" target="_blank" rel="noopener noreferrer">官網這篇</a>,官網是建議用<code>terraform apply --refresh-only</code></p></div></div></li><li><code>terraform destroy</code>: 刪除 Terraform 建立的基礎設施。</li><li><code>terraform validate</code>: 驗證 Terraform 配置文件的正確性。</li><li><code>terraform fmt</code>: 格式化 Terraform 配置文件，使其符合慣例。</li><li><code>terraform state list</code>: 列出 Terraform 管理的資源狀態,就是 resource 有哪些拉。</li><li><code>terraform state show</code>: 顯示特定資源的詳細狀態。</li><li><code>terraform import</code>: 將現有的基礎設施資源導入 Terraform 管理。</li><li><code>terraform output</code>: 顯示 Terraform 輸出的變數值。</li><li><code>terraform workspace new</code>: 建立新的 Terraform 工作區,workspace 主要是用來區分 &quot;dev&quot;、&quot;test&quot; 和 &quot;prod&quot; 的工作區.</li><li><code>terraform workspace select</code>: 切換到指定的 Terraform 工作區</li><li><code>terraform workspace list</code>: 列出所有可用的 Terraform 工作區</li><li><code>terraform workspace show</code> 查詢現在工作區,預設為 default</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="很重要的tfstate">很重要的.tfstate<a href="#很重要的tfstate" class="hash-link" aria-label="Direct link to 很重要的.tfstate" title="Direct link to 很重要的.tfstate">​</a></h3><p>當資源被刪除後會看到空的格式</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;version&quot;: 4,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;terraform_version&quot;: &quot;1.4.6&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;serial&quot;: 9,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;lineage&quot;: &quot;117a2911-77fe-3d31-2511-d1819cceb839&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;outputs&quot;: {},</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;resources&quot;: [],</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;check_results&quot;: null</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>有以下 key</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">[</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;check_results&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;lineage&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;outputs&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;resources&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;serial&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;terraform_version&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;version&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>apply 之後,資源產出,會把 value 填進去.其中 resources 是紀錄 .tf 檔案產生的資源,就是現階段遠端資源狀態.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="terraform-state">Terraform State<a href="#terraform-state" class="hash-link" aria-label="Direct link to Terraform State" title="Direct link to Terraform State">​</a></h4><p>State（狀態）在 Terraform 中是一個核心概念和架構,是個抽象層,代表了 Terraform 管理的基礎設施的當前狀態，包括已創建的資源、屬性值、相依關係等.terraform 支援許多不同的 State 實作(雲端各廠,地端)，不同實作的機制不同，但都能滿足上面描述的 State 概念.</p><p>主要以下幾個功用</p><ul><li>Mapping to the Real World: Terraform 是透過.state 裡面的 metadata 去對應現實資源.</li><li>Metadata: 除了 mapping 必須資料外，State 也外存放 Terraform runtime 需要的資料</li><li>Performance: 預設下,每次 apply 都會先打ＡＰＩ同步遠端架構,在小架構如果每次執行確認 state 是沒問題的,但大公司就會遇到設施太多可能超過 API 限速,所以會透過-refresh=false 直接用目前 state 檔案當作遠端狀態！</li><li>Syncing: 在多人協作場合下,建議用<a href="https://developer.hashicorp.com/terraform/language/state/remote" target="_blank" rel="noopener noreferrer">Remote state</a>做管理,可以做到遠端鎖定<!-- -->*<!-- -->.tf 避免執行過程中被編輯.</li></ul><p>基本上 backend 分成 local 跟 remote,前者是把 state 維護在地端,後者是把 state 維護在遠端,並可以對遠端產生 lock,多人協作(公司)是建議用 remote 做管理！</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="local-backend-管理-state">local backend 管理 state<a href="#local-backend-管理-state" class="hash-link" aria-label="Direct link to local backend 管理 state" title="Direct link to local backend 管理 state">​</a></h3><span style="background-color:#1877F2;border-radius:20px;color:#fff;padding:6px;cursor:pointer">在個人專案下</span>,使用 Local Backend 來管理 Terraform State 就好,也就是會產生 terraform.tfstate 檔案 .換句話說用遠端版本控管不會產生這個檔案！如果多人協作下,只有單純用 local backend,將 State 存儲在本地，然後透過 git 同步版控 State ，過程會很麻煩,當你修改完 tf 檔要 commit,在執行 plan 或 apply 會隨即更新 state,這個 state 也要 commit,很容易漏掉！另外,你使用的機密資料也會寫在 state !<h3 class="anchor anchorWithStickyNavbar_LWe7" id="remote-backend-管理-state">remote backend 管理 state<a href="#remote-backend-管理-state" class="hash-link" aria-label="Direct link to remote backend 管理 state" title="Direct link to remote backend 管理 state">​</a></h3><span style="background-color:#1877F2;border-radius:20px;color:#fff;padding:6px;cursor:pointer">當在多人協作或具有分佈式團隊的情況下</span>，建議使用遠端的 State 存儲後端，例如 Terraform Cloud、AWS S3、Azure Blob Storage 等.<p>這些遠端後端提供了更好的版本控制,協作和安全性，可以更好地管理 Terraform State.
每個雲廠商,都會提供管理 state 的方式,例如 aws 用 s3 保存 state,用 dynamo db 作設定檔 lock,不過因為眾多原因,這邊會用 terraform cloud 做我的 remote backend.</p><ol><li>先到 terraform cloud 建立帳號,並建立 organization(專案),workspace(就環境,會分 dev,test,prod)</li><li>修改 provider.tf</li></ol><div class="language-jsx codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">provider.tf</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-jsx codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">terraform </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    cloud </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    organization </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;ford-org&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    workspaces </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      name </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;dev&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  required_providers </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    aws </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      source  </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;hashicorp/aws&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      version </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;~&gt; 4.16&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  required_version </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;&gt;= 1.2.0&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ol start="3"><li>執行<code>terraform init</code>,會跑出讓你確認,這邊主要就是告訴你會轉移 state 到雲端.</li></ol><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Initializing Terraform Cloud...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Do you wish to proceed?</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  As part of migrating to Terraform Cloud, Terraform can optionally copy your</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  current workspace state to the configured Terraform Cloud workspace.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Answer &quot;yes&quot; to copy the latest state snapshot to the configured</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Terraform Cloud workspace......</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Should Terraform migrate your existing state?</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Enter a value:</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ol start="4"><li>把 terraform.tfstate 刪去(因為現在 state 會維持在雲端,不在地端)</li></ol><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">rm terraform.tfstate</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ol start="5"><li><p>In terraform cloud,add your AWS_ACCESS_KEY_ID and AWS_SECRET_ACCESS_KEY as Environment Variables</p></li><li><p>Terraform cloud 的 overview 那邊,可以設定很多模式</p></li></ol><div class="theme-admonition theme-admonition-info alert alert--info admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_S0QG"><ul><li><p>Execution Mode 可以設定成 Remote or Local,Remote 就需要在 terraform cloud 那邊去執行你要做的 apply,refresh 等等,如果是 Local 那就只是在地端下指令,然後把 state 維護在雲端.</p></li><li><p>Apply Method 也很重要,你選 auto 會變成不需要人 approve,manual 就是要有人 approve 去再確認才會執行！</p></li></ul></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="小結">小結<a href="#小結" class="hash-link" aria-label="Direct link to 小結" title="Direct link to 小結">​</a></h3><p>用 IaC 最重要的是多人協作,如果做不到多人協作,version control,嚴謹的控管原則,那就建議不要導入！除非單純就拿來開資源.</p><p>透過以上,應該要了解</p><ul><li>terraform 操作第一大準則</li><li>terraform init,plan,apply 指令會發生啥事？</li><li>HCL 語言是啥,有哪些資料型態？</li><li>terraform init -upgrade 啥時用,可以指定資源？</li><li>terraform 規劃檔案的內容放置方式? 常用區塊有哪些？</li><li>如果有人跑去用 UI 改資訊,如何刷新 state 去 follow 新資訊?</li><li>state 是啥？</li><li>backend 是啥? 他有分哪兩大類? 多人合作有選哪種？</li></ul><p>接下來,會著重在實作上,包括拉取資源,module,function 等.</p><div class="theme-admonition theme-admonition-info alert alert--info admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_S0QG"><p>參考資料</p><ol><li><a href="https://developer.hashicorp.com/terraform/intro" target="_blank" rel="noopener noreferrer">Terraform 官網</a></li><li><a href="https://github.com/chechiachang/terraform-30-days/blob/main/lecture/zh/01-introduction.md" target="_blank" rel="noopener noreferrer">terraform-30-days</a></li><li><a href="https://betterprogramming.pub/terraformer-converting-infrastructure-into-reusable-terraform-code-afe543ad0b15" target="_blank" rel="noopener noreferrer">Terraformer: Converting Infrastructure Into Reusable Terraform Code</a></li></ol></div></div></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/terraform">Terraform</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/ia-c">IaC</a></li></ul></div></footer></article><div id="disqus_thread"></div><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><meta itemprop="image" content="https://github.com/suyuying.png"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/blog/2023/05/14/Others/steps-to-resovle-http-status">Steps to resolve web application problem</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2023-05-14T00:00:00.000Z" itemprop="datePublished">May 14, 2023</time> · <!-- -->7 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/suyuying" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://github.com/suyuying.png" alt="zaxro"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/suyuying" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">zaxro</span></a></div><small class="avatar__subtitle" itemprop="description">Life is too short to live someone else&#x27;s dream</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><h2 class="anchor anchorWithStickyNavbar_LWe7" id="判斷邏輯">判斷邏輯<a href="#判斷邏輯" class="hash-link" aria-label="Direct link to 判斷邏輯" title="Direct link to 判斷邏輯">​</a></h2><p>網路服務會發生問題狀況有很多,以下會用樹狀圖去做個判斷邏輯,當然這是建立在我目前遇到過的各種各樣情況上,同時也會加上判斷中會使用的方法！</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="http-status-介紹">HTTP status 介紹<a href="#http-status-介紹" class="hash-link" aria-label="Direct link to HTTP status 介紹" title="Direct link to HTTP status 介紹">​</a></h3><ul><li>1xx - 資訊性狀態碼（Informational Status Codes）：表示請求已收到，並且伺服器仍在處理中.</li><li>2xx - 成功狀態碼（Success Status Codes）：表示請求成功被伺服器接受和處理.</li><li>3xx - 重新導向狀態碼（Redirection Status Codes）：表示需要進行進一步的操作以完成請求.</li><li>4xx - 用戶端錯誤 : 常見有 400 請求無效,server 無法理解,404 資源不存在</li><li>5xx（Server Error Status Codes）- 伺服器在處理請求時發生錯誤.</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="4xx-判斷過程及工具">4xx 判斷過程及工具<a href="#4xx-判斷過程及工具" class="hash-link" aria-label="Direct link to 4xx 判斷過程及工具" title="Direct link to 4xx 判斷過程及工具">​</a></h3><p>出現 4xx 不一定全是 client 問題,因為這與你 server 端 code 可能有關係,可能今天問題是 RD 的靜態資源放錯路徑,前端拿不到,也有可能是客戶端編碼跟 API 串接方式錯誤等等.</p><p>在排查此類問題,客戶端提供的報錯節圖,url,跟網路速度都是重要判斷依據.如果明確知道問題原因,那可以直接跳階段測試,不知道原因的話建議可以以下判斷:</p><ol><li>靜態資源未拿到: 請客戶端檢查網路環境,提供網路速度,ping 跟 traceroute 結果,是否有清 cache,server 端確認是否有此資源,跟有無 purge.</li><li>編碼問題: 這要看 server log,並請開發人員溝通.</li></ol><p>順序問題,4xx 的問題可以從 client 端開始查到 server 端.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="5xx-判斷過程跟工具">5xx 判斷過程跟工具<a href="#5xx-判斷過程跟工具" class="hash-link" aria-label="Direct link to 5xx 判斷過程跟工具" title="Direct link to 5xx 判斷過程跟工具">​</a></h3><p>主要跟 code,hardware, app&#x27;s condition,internet 都有關係,且可能彼此混雜,就 RD 覺得是 IT 設定 waf,IT 覺得是ＲＤ的程式問題. 也因此,建立判斷的過程很重要.</p><ol><li><p>hardware 問題,基本上有裝監控項可以看到性能就沒問題</p></li><li><p>internet 問題,這邊就很複雜了,如果基本的 server 端互相 telnet 都有過,那接下來就要乖乖重投檢查了,這邊先不考慮 ICP 或雲服務商掛掉,這兩個掛掉應該很多網站都會掛,那剩下就是排查 waf.排查 waf 工具有以下</p><ul><li>/etc/hosts: 綁定 DNS</li><li>web server 端的 curl.</li></ul></li></ol><h4 class="anchor anchorWithStickyNavbar_LWe7" id="排查流程">排查流程<a href="#排查流程" class="hash-link" aria-label="Direct link to 排查流程" title="Direct link to 排查流程">​</a></h4><p>網路發出的流程會是:<code>client</code>請求 -&gt; CDN -&gt; <code>web server</code>轉導-&gt; <code>後端程式</code>處理</p><p>所以排查順序也可以是由外到內,client 端開始查,但通常都是並行的,就是 client 端那邊查網路連線品質,server 端也同時看服務情況跟 log.</p><ul><li><p>情境一: 客戶反應說他的 request 被攔截了,原因是 xxx cors.</p><p>檢查流程：</p><ol><li>先去 CDN 看是否被 WAF 阻擋.</li><li>web server 看是否有設定 WAF 或者有設定跨域設定,及其阻擋紀錄.</li><li>後端程式規範的跨域跟安全套件.</li></ol></li><li><p>情境二: 客戶反應說他的 request 被攔截了,原因是 xxx header 的 sameorigin problem.</p><p>檢查流程：</p><ol><li>先去 CDN 看是否被 WAF 阻擋,如無,就綁定/etc/hosts 不走 CDN 直接到 web server ip 做測試</li><li>web server 檢查是否有限定 header.</li><li>從 web server 那邊直接 curl 目標 server ip:port,ex.以下指令示範</li></ol></li></ul><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">curl -v http://10.0.0.1:92</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>去看請求後端時是否就有強迫帶該 header,如有就代表程式端有帶套件去加 header</p><ol start="4"><li>code 端可能用的套件,例如 js 的<code>helmet</code>套件.</li></ol><p>在測試流程中發現限制,也不代表你一定要開放,例如,iframe 的內嵌就會牽涉到點擊劫持,跨站腳本攻擊（Cross-Site Scripting, XSS),內容竊取,會限制就會有他的原因.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="非-4xx-或-5xx">非 4xx 或 5xx<a href="#非-4xx-或-5xx" class="hash-link" aria-label="Direct link to 非 4xx 或 5xx" title="Direct link to 非 4xx 或 5xx">​</a></h3><p>這個判斷基本上就是看 F12 報錯項目了,看完之後的判斷,也是依據 4xx 或 5xx 類別去判斷.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="小結">小結<a href="#小結" class="hash-link" aria-label="Direct link to 小結" title="Direct link to 小結">​</a></h3><p>基本上,排查流程一定要有個順序,由外到內或內到外(看習慣),客戶端到 server 中間的所有事情都要一個一個查,剛開始可能因為經驗不足,到一半就會放棄了,像我就是ＸＤ,但隨著時間增加,看得問題也變多了,就要去紀錄不足之處,以及中間固定要做的事情!</p><p>如果排查一遍還是找不到問題,就要去想你過程可能漏掉哪些細項,哪些測試是可以做但你還沒做或不知道怎麼做的！</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/sre">SRE</a></li></ul></div></footer></article><div id="disqus_thread"></div><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><meta itemprop="image" content="https://github.com/suyuying.png"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/blog/2023/05/12/Aws/cloudwatch-cloudtrail">Basic introduction of cloudwatch and  cloudtrail</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2023-05-12T00:00:00.000Z" itemprop="datePublished">May 12, 2023</time> · <!-- -->6 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/suyuying" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://github.com/suyuying.png" alt="zaxro"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/suyuying" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">zaxro</span></a></div><small class="avatar__subtitle" itemprop="description">Life is too short to live someone else&#x27;s dream</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>以下內文會提供的資訊：</p><ul><li>cloudwatch and cloudtrail 是什麼</li><li>什麼時候會用到 cloudwatch and cloudtrail？</li><li>基本建立 cloudwatch 監控 ec2 CPU</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="cloudwatch">cloudwatch<a href="#cloudwatch" class="hash-link" aria-label="Direct link to cloudwatch" title="Direct link to cloudwatch">​</a></h2><p>CloudWatch 提供了即時的監控功能，可以監視 AWS 資源的狀態和性能指標,例如 CPU 使用率、網路流量和存儲使用量等。此外，CloudWatch 還可以設定警報，當資源的指標達到預先設定的閾值時，它可以發送通知。CloudWatch 還提供了日誌記錄的功能，以收集、監視和分析應用程式和資源的日誌。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="什麼時候會用到-cloudwatch">什麼時候會用到 cloudwatch<a href="#什麼時候會用到-cloudwatch" class="hash-link" aria-label="Direct link to 什麼時候會用到 cloudwatch" title="Direct link to 什麼時候會用到 cloudwatch">​</a></h3><p>一般公司會使用 Zabbix,Prometheus,這類工具做到即時監控資源功能,而日誌分析部分,可以用的工具也很多,例如 ELK</p><ul><li>那為啥要使用 cloudwatch?</li></ul><p>個人以為考量的點是建制以上服務的時間成本,當你這台在 AWS 機器可能只會開個一段時間,且網路不通到監控機台或者公司剛成立監控還沒做,以上這些情況會讓你考慮用到 cloudwatch, 一般要長期監控的伺服器還是會用 Zabbix,Prometheus 等</p></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/aws">AWS</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/cloudwatch">cloudwatch</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/cloudtrail">cloudtrail</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about Basic introduction of cloudwatch and  cloudtrail" href="/blog/2023/05/12/Aws/cloudwatch-cloudtrail"><b>Read More</b></a></div></footer></article><div id="disqus_thread"></div><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><meta itemprop="image" content="https://github.com/suyuying.png"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/blog/2023/05/11/Aws/s3-basic-intro">aws s3 basic introduction and attach iam role to operate s3</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2023-05-11T00:00:00.000Z" itemprop="datePublished">May 11, 2023</time> · <!-- -->7 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/suyuying" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://github.com/suyuying.png" alt="zaxro"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/suyuying" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">zaxro</span></a></div><small class="avatar__subtitle" itemprop="description">Life is too short to live someone else&#x27;s dream</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><h2 class="anchor anchorWithStickyNavbar_LWe7" id="basic-introduction">basic introduction<a href="#basic-introduction" class="hash-link" aria-label="Direct link to basic introduction" title="Direct link to basic introduction">​</a></h2><p>S3(simple storage service)負責檔案儲存跟管理,你可以當他是個 NAS,只是不用管理作業系統,跟監控他的機器狀況.
相比於 EBS(Elastic Block Store)需要跟 EC2 一起使用,S3 只需要做到資料管理部分！</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="儲存形式">儲存形式<a href="#儲存形式" class="hash-link" aria-label="Direct link to 儲存形式" title="Direct link to 儲存形式">​</a></h3><ul><li>standard storage:默認儲存類型,提供高持久性、高可用性和低延遲的存儲,適合各種使用案例</li><li>intelligent-tiering:根據數據的訪問模式自動將數據分類到適合的儲存層級，以實現成本效益和性能優化</li><li>Glacier:適用於需要長期保存的數據，但對訪問速度要求不高</li><li>Standard-IA:IA 適用於不常存取但需要在必要時進行快速存取的資料,非常適合長期儲存、備份和做為災難復原檔案的資料</li><li>one Zone IA: IA 適用於不常存取但需要在必要時進行快速存取的資料。它會將資料存放到單一 AZ 中，而且成本較 S3 標準 – IA 減少 20%。</li><li>Glacier-deep-Archieve:這是一種封存儲存類別，可提供最低成本的儲存和毫秒級擷取。針對不需要立即存取但需要靈活且免費擷取大型資料集的封存資料，例如備份或災難復原使用案例,資料擷取時間為 12-48 小時。</li><li>S3 Glacier Instant Retrieval:封存儲存類別，可為很少存取且需要在幾毫秒內擷取的長期資料提供最低成本的儲存。當您的資料每季度存取一次時，請使用 S3 Glacier Instant Retrieval</li></ul><p>簡單整理，S3 選擇一般使用就用 standard,如果可能是幾小時拿一次用 IA 系列,不擔心東西資源掛掉就放在 one-zone 省錢,如果是長期封存資料就考慮用 Glacier 系列.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="s3-vs-vpc">S3 vs VPC<a href="#s3-vs-vpc" class="hash-link" aria-label="Direct link to S3 vs VPC" title="Direct link to S3 vs VPC">​</a></h3><p>因為 S3 都是在 VPC 外建立,存取 S3 有兩種方式</p><ul><li>從網際網路存取 S3(透過 url 拿東西,這邊就不介紹)</li><li>從 VPC 當中伺服器存取 S3 檔案</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="從-vpc-當中伺服器存取-s3-檔案">從 VPC 當中伺服器存取 S3 檔案<a href="#從-vpc-當中伺服器存取-s3-檔案" class="hash-link" aria-label="Direct link to 從 VPC 當中伺服器存取 S3 檔案" title="Direct link to 從 VPC 當中伺服器存取 S3 檔案">​</a></h3><p>透過建立 IAM role,並將適當的 IAM policy 賦給該 IAM Role,並經該 role 指派給 ec2,就可以讓 EC2 透過暫時性的安全憑證向 S3 或其他 AWS 資源做請求！</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="ec2-透過-vpc-endpoint-連結-s3">EC2 透過 VPC endpoint 連結 S3<a href="#ec2-透過-vpc-endpoint-連結-s3" class="hash-link" aria-label="Direct link to EC2 透過 VPC endpoint 連結 S3" title="Direct link to EC2 透過 VPC endpoint 連結 S3">​</a></h4><p><a href="https://docs.aws.amazon.com/zh_tw/AmazonS3/latest/userguide/privatelink-interface-endpoints.html" target="_blank" rel="noopener noreferrer">官網</a> ,主要優勢在於可以使用 VPC Endpoint 將 EC2 實例連接到 S3 資源，使其可以在 VPC 內部訪問 S3 而無需通過 Internet。這樣可以提高安全性並降低流量的出口。</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="如何設定-role-給-ec2">如何設定 role 給 ec2<a href="#如何設定-role-給-ec2" class="hash-link" aria-label="Direct link to 如何設定 role 給 ec2" title="Direct link to 如何設定 role 給 ec2">​</a></h4><ul><li>打開 IAM 控制台並選擇「角色」。</li><li>點擊「創建角色」。</li><li>在選擇您的使用案例下，選擇「EC2」。</li><li>在「權限」頁面上，選擇您希望為 EC2 實例提供的權限，或創建自定義的 IAM 策略來指定您需要的權限。</li><li>在「標籤」頁面上，根據需要添加標籤，然後點擊「下一步」。</li><li>在「回顧」頁面上，為角色指定一個名稱，並選擇「創建角色」。
現在，您已經創建了一個 IAM 角色，接下來您需要將該角色附加到 EC2 實例上：</li></ul><p>打開 EC2 控制台並選擇您的實例：</p><ul><li>Actions -&gt;Security -&gt;modify iam role</li><li>選擇您創建的 IAM 角色，然後點擊「保存」。</li><li>基本上,等 s3 bucket 創建好以後就大功告成拉,實務上可以把開機要執行的腳本,透過拉取 s3 資源並使用！</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="s3-設定">S3 設定<a href="#s3-設定" class="hash-link" aria-label="Direct link to S3 設定" title="Direct link to S3 設定">​</a></h3><p>主要有三關會設定,這邊先不討論設定 CORS 那些設定</p><ol><li>公開存取設定: 這個其實是單純防呆設定,預設是完全禁止公開,所以通常是網頁資源就需要打開,單純給ＥＣ 2 拿東西可以不用公開</li><li>ACL of S3: 對各類使用者給予 List or Write or Read 等權限,不過預設是會有 bucket owner enforced 屬性,讓對 bucket 的存取單純由 Bucket policy 規範</li><li>Bucket Policy: 這個就是類似 IAM policy 制定規則方式,透過 EPCAR 去規範資源存取.</li></ol><h4 class="anchor anchorWithStickyNavbar_LWe7" id="建立-bucket">建立 bucket<a href="#建立-bucket" class="hash-link" aria-label="Direct link to 建立 bucket" title="Direct link to 建立 bucket">​</a></h4><ol><li><p>登入 AWS 管理控制台，並打開 S3 服務。</p></li><li><p>在 S3 控制台的首頁上，點擊「創建存儲桶」。</p></li><li><p>在「名稱和區域設置」頁面上，為存儲桶指定一個唯一的名稱。請注意，存儲桶的名稱在全球範圍內必須是唯一的，且符合命名規則。您還可以選擇存儲桶所在的區域,在「設置選項」部分，您可以選擇適當的選項，如版本控制、加密和存儲桶日誌等。根據您的需求選擇相應的設置。</p></li><li><p>在「權限設置」部分，您可以為存儲桶指定存取權限。根據需求，可以選擇公共存取設置、存取控制清單（ACL）或存取策略。主要理解為啥會有三個要設定,存取策略是啥～</p></li><li><p>確認您的設置並點擊「創建存儲桶」。如果要改存檔類型,要點到指定文件-&gt; actions -&gt; Edit storage class -&gt;看到一堆類型囉！</p></li></ol></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/aws">AWS</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/s-3">S3</a></li></ul></div></footer></article><div id="disqus_thread"></div><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><meta itemprop="image" content="https://github.com/suyuying.png"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/blog/2023/05/10/Others/interview-question">運維,DevOps,SRE常見問題</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2023-05-10T00:00:00.000Z" itemprop="datePublished">May 10, 2023</time> · <!-- -->4 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/suyuying" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://github.com/suyuying.png" alt="zaxro"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/suyuying" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">zaxro</span></a></div><small class="avatar__subtitle" itemprop="description">Life is too short to live someone else&#x27;s dream</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><h2 class="anchor anchorWithStickyNavbar_LWe7" id="sre">SRE<a href="#sre" class="hash-link" aria-label="Direct link to SRE" title="Direct link to SRE">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="使用過的-iac-工具">使用過的 IaC 工具<a href="#使用過的-iac-工具" class="hash-link" aria-label="Direct link to 使用過的 IaC 工具" title="Direct link to 使用過的 IaC 工具">​</a></h3><h3 class="anchor anchorWithStickyNavbar_LWe7" id="使用過的域名證書管理工具">使用過的域名、證書管理工具<a href="#使用過的域名證書管理工具" class="hash-link" aria-label="Direct link to 使用過的域名、證書管理工具" title="Direct link to 使用過的域名、證書管理工具">​</a></h3><p>基本上這邊就看個人回答,工具部分有 certbot 可以做定期 renew 憑證!</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="devops">DevOps<a href="#devops" class="hash-link" aria-label="Direct link to DevOps" title="Direct link to DevOps">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="雲端平台理解">雲端平台理解<a href="#雲端平台理解" class="hash-link" aria-label="Direct link to 雲端平台理解" title="Direct link to 雲端平台理解">​</a></h3><ul><li><p>IAM:</p></li><li><p>VPC:</p></li><li><p>peering connection</p></li><li><p>cloudwatch</p></li><li><p>cloudtrail</p></li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="請問心目中理想-pipeline">請問心目中理想 pipeline!<a href="#請問心目中理想-pipeline" class="hash-link" aria-label="Direct link to 請問心目中理想 pipeline!" title="Direct link to 請問心目中理想 pipeline!">​</a></h3><p>理想的 CI/CD pipeline 應該具有自動化、快速、可靠且能快速反饋.</p><ul><li>自動化:基本上滿直觀得,跑 CI/CD 就是希望減少手動,所以盡量要讓所有過程自動</li><li>快速部分:各家 CI 會有不同配置,主要是透過檢視流程,讓沒有相依性的 jobs 可以平行處理,並適當使用 cache,減小使用的 image size 等等.</li><li>可靠: pipline 流程設計要有一致性,部署的環境跟資料源穩定</li><li>快速反饋: 將過程成功或失敗,透過 webhook 或其他方式發送到通訊平台</li></ul><p>ps: pipline 過程</p><ul><li>code management: 程式碼依規定建立分支,tag,commit 放入版本控制系統,</li><li>Build: 將檔案進行編譯</li><li>自動測試：包含單元測試,整合測試,確定新開發的 function 功能不會破壞既有功能</li><li>(optional)建 image 並推到 registry: 這適用於用 container 部署的項目</li><li>部署到測試環境: 環境可能有很多個,如果用 ec2 之類是用 ssh 做部署(可以配合 ansible 腳本),如果是 image 就有需要並執行的過程！</li><li>驗證: 對於新開發功能進行驗證,確認功能正常,符合需求</li><li>部署到 production</li><li>監控:這牽涉到硬體跟服務的日誌監控跟分析</li><li>Rollback: ㄧ旦發現要能進行 rollback</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="如何提升系統穩定性ex-證券業降低伺服器意外故障風險">如何提升系統穩定性（ex 證券業）,降低伺服器意外故障風險？<a href="#如何提升系統穩定性ex-證券業降低伺服器意外故障風險" class="hash-link" aria-label="Direct link to 如何提升系統穩定性（ex 證券業）,降低伺服器意外故障風險？" title="Direct link to 如何提升系統穩定性（ex 證券業）,降低伺服器意外故障風險？">​</a></h3><p>雲端部分,的確是會遇到某個 AZ 機器突然掛掉的問題,畢竟他對機器保障的 down time 本來就不是 100%,如果是用 VM 之類起服務,可以在將服務部署在同一 Region 的各 AZ 中,即使一個 VM 掛了,其他的也可以提供服務！ 地端機器也是同樣概念！</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="運維">運維<a href="#運維" class="hash-link" aria-label="Direct link to 運維" title="Direct link to 運維">​</a></h2><p>基本上,他就是全包所有東東(除了開發),著重維護底層,或許會碰到部署,所以基本上要有以下觀念</p><ul><li>監控系統建立跟操作: 一般硬體,process 監控,port 監控,常用資源:Zabbix,Grafana,Prometheus</li><li>日誌系統: 日誌系統收集跟傳輸資訊:filebeat,日誌系統分析:ELK,Graylog.</li><li>資料庫管理: 設計，管理和維護資料庫，包括備份和恢復，性能優化，安全管理等。</li><li>網路管理: 維護和管理網絡設備，如交換機，路由器和防火牆。包括設置網絡拓撲，網絡設置和配置，網絡性能優化和維護,包含雲端跟地端.</li><li>安全性管理: 確保系統和數據得到妥善保護，防止未經授權的訪問和數據洩漏,包含防毒安裝.</li><li>軟體管理: 軟體部署,跟版本管理等</li><li>資料備份和災難恢復: 確保所有資料都能夠備份和恢復,並建立計畫並測試.</li></ul></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/運維">運維</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/dev-ops">DevOps</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/sre">SRE</a></li></ul></div></footer></article><div id="disqus_thread"></div><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><meta itemprop="image" content="https://github.com/suyuying.png"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/blog/2023/05/03/IaC/yml-syntax">YAML語法結構介紹</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2023-05-03T00:00:00.000Z" itemprop="datePublished">May 3, 2023</time> · <!-- -->6 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/suyuying" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://github.com/suyuying.png" alt="zaxro"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/suyuying" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">zaxro</span></a></div><small class="avatar__subtitle" itemprop="description">Life is too short to live someone else&#x27;s dream</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><h2 class="anchor anchorWithStickyNavbar_LWe7" id="yaml-and-json">yaml and json<a href="#yaml-and-json" class="hash-link" aria-label="Direct link to yaml and json" title="Direct link to yaml and json">​</a></h2><p>Yaml 跟 Json 都是用於日常進行資料處理,Json 相信大家很熟了,前後端資料溝通最常用到的就是 Json,因為他跟 python 的 dict 格式超像,所以熟悉 json 也很快,差別在前者是 python 物件,後者是有固定格式且方便機器解析的純文字的數據交換格式,規則是名稱寫在雙引號內，值可以是字符串、數字、對象、數組、布爾值或 null。</p><div class="language-jsx codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">json基本範例</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-jsx codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string-property property" style="color:#36acaa">&quot;name&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;John&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string-property property" style="color:#36acaa">&quot;age&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">30</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string-property property" style="color:#36acaa">&quot;city&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;New York&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string-property property" style="color:#36acaa">&quot;hobbies&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;reading&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;music&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;sports&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string-property property" style="color:#36acaa">&quot;isMarried&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string-property property" style="color:#36acaa">&quot;spouse&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword null nil" style="color:#00009f">null</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Yaml 相對於 Json 來說,對我個人而言,在表達複雜資料結構上,例如多層次的陣列,更好了解一些,主要使用縮排和簡潔的語法來表示結構和層次.</p><p>基本語法重點:</p><ul><li>有---開頭,通常就是 yml 格式,但沒強制要加</li><li>使用縮排表示層級</li><li>使用空格做縮排,,建議使用 2 或 4 個空格,不建議用 tab</li><li>字符串不用加引號,在可能產生歧義時,需加單引號 or 雙引號.(單引號包圍字符串時，會將特殊符號保留。雙引號包圍字符串時，反斜線需要額外進行轉義。)</li></ul><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">## 以下key3等於key4,注意使用單引號跟雙引號差別</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- key3: &#x27;\.php$&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- key4: &quot;\\.php$&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>支持多種數據類型，包括字典、列表、布爾值、整數、浮點數等。</li><li>用# 註解</li></ul><p>關於歧義這點,近一步說明:
使用 &quot;:&quot; 字符時，可能會被解析成 key-value 的形式，需要加引號來避免歧義。
字符串包含 &quot;-&quot; 字符時，可能被解析成列表中的項目，需要加引號來避免歧義。
字符串包含 &quot;#&quot; 字符時，可能被解析成注釋，需要加引號來避免歧義。</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 不用引號</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">key: value</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 需要加引號避免歧義</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">key: &quot;value:with:colon&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 需要加引號避免歧義</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">key: &quot;value-with-dash&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 不用引號(但是為了避免麻煩,遇到#都習慣加引號吧)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">key: &quot;#no-comments&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 需要加引號避免歧義</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">key: &quot;# comments&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="yaml-數據結構">yaml 數據結構<a href="#yaml-數據結構" class="hash-link" aria-label="Direct link to yaml 數據結構" title="Direct link to yaml 數據結構">​</a></h3><p>yml 支持多種數據類型，包括字典、列表、布爾值、整數、浮點數等.</p><p>這邊建議可以安裝 yq 把 yml 解析成 json,方便習慣用 json 得人了解 yml.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">pip3 install yq</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>接下來會了解字典、列表、Boolean、整數、浮點數如何表達,以下的 yml 用法跟出現的 json 是相同意思的！</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="字典">字典<a href="#字典" class="hash-link" aria-label="Direct link to 字典" title="Direct link to 字典">​</a></h4><p>以下二者相等</p><div class="language-jsx codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">yaml dict</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-jsx codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token literal-property property" style="color:#36acaa">name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token maybe-class-name">Helloworld</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-jsx codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">json dict</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-jsx codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string-property property" style="color:#36acaa">&quot;name&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;junmajinlong&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="列表">列表<a href="#列表" class="hash-link" aria-label="Direct link to 列表" title="Direct link to 列表">​</a></h4><div class="language-jsx codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">yaml list</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-jsx codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">-</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> lang1</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token maybe-class-name">Shell</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> lang2</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">JS</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> lang3</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token maybe-class-name">Python</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-jsx codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">json list</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-jsx codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token literal-property property" style="color:#36acaa">mylang</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Shell&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token literal-property property" style="color:#36acaa">mylang2</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;JS&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token literal-property property" style="color:#36acaa">mylang3</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Python&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="boolean">boolean<a href="#boolean" class="hash-link" aria-label="Direct link to boolean" title="Direct link to boolean">​</a></h4><div class="language-jsx codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">yaml boolean</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-jsx codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token literal-property property" style="color:#36acaa">is_published</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">is_featured</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-jsx codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">json boolean</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-jsx codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string-property property" style="color:#36acaa">&quot;is_active&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string-property property" style="color:#36acaa">&quot;is_admin&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="yml-的-dict-跟-list-混合表達">yml 的 dict 跟 list 混合表達<a href="#yml-的-dict-跟-list-混合表達" class="hash-link" aria-label="Direct link to yml 的 dict 跟 list 混合表達" title="Direct link to yml 的 dict 跟 list 混合表達">​</a></h4><p>這個格式在 docker 跟 ansible 之類很常見,其實他是這樣滴！</p><div class="language-jsx codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">yaml dict and list</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-jsx codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">-</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 值是純list</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">有三個</span><span class="token operator" style="color:#393A34">-</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">所以有三個元素</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">languages</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> </span><span class="token maybe-class-name">Shell</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">JS</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> </span><span class="token maybe-class-name">Python</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 值是dict </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> list</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">因為只有一個</span><span class="token operator" style="color:#393A34">-</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">代表只有一個元素</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">該元素type為dict</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">services</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> nginx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">status</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> running</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-jsx codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">json dict and list</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-jsx codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string-property property" style="color:#36acaa">&quot;languages&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;Shell&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;JS&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;Python&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string-property property" style="color:#36acaa">&quot;services&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token string-property property" style="color:#36acaa">&quot;name&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;nginx&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token string-property property" style="color:#36acaa">&quot;status&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;running&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>到這邊,基本上對 yml 就有一定熟悉度,在寫 config 時,腦袋也跟著跑出 json 的檔案範例.</p></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/yml">yml</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/config">config</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about YAML語法結構介紹" href="/blog/2023/05/03/IaC/yml-syntax"><b>Read More</b></a></div></footer></article><div id="disqus_thread"></div><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><meta itemprop="image" content="https://github.com/suyuying.png"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/blog/2023/04/30/IaC/importance-of-IaC">The importance of IaC</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2023-04-30T00:00:00.000Z" itemprop="datePublished">April 30, 2023</time> · <!-- -->11 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/suyuying" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://github.com/suyuying.png" alt="zaxro"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/suyuying" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">zaxro</span></a></div><small class="avatar__subtitle" itemprop="description">Life is too short to live someone else&#x27;s dream</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>基本上我學新的工具都會先做幾件事情</p><ol><li>中文 google 搜尋看有哪些資源</li><li>乖乖把官網教學文章看過一遍,以及官網的一些重要的基礎文章看完</li></ol><p>基本上都會先看官網文件,如果官網怎麼看都不懂,會用中文的教學文件輔助,還好,terraform 的教學文件很不錯～
當基本資料學完之後,以我的資質一定還是很不熟,所以接著會做幾件事情</p><ol><li>寫篇文件把基本型態,跟常用方式整理一下(像這篇)</li><li>參考別人的實戰教學</li><li>實作</li></ol><p>這邊,每件都很重要,把你懂的事情記錄下來有很多好處</p><ul><li>你未來遇到事情可以複習</li><li>如果以前觀念錯誤可以改正</li><li>要找人討論事情或求教,他可以透過文章先了解你的程度</li></ul><p>參考別人實戰經驗可以減少自己踩坑機率！</p><p>最後,學東西就是要實作,不實作或導入,那有學跟沒學一樣!</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="iac-常見管理項目">IaC 常見管理項目<a href="#iac-常見管理項目" class="hash-link" aria-label="Direct link to IaC 常見管理項目" title="Direct link to IaC 常見管理項目">​</a></h2><p>一個網路服務的提供,中間會經過許多關卡,這邊大致整理以下:</p><ol><li>軟體開發或者更新</li><li>測試環境部署並測試</li><li>正式環境上線</li><li>監控環境</li></ol><p>看幾來步驟很少,但實際上細節很多,而且隨著公司技術程度越高,這些過程會被切得越複雜.</p><p>軟體開發或者更新的過程,會被切割成,依據 github flow(每家邏輯不同)對各需求,建立不同分支,RD 的 code 推上來之後,要確保品質會經過測試階段,最後合 code,接下來就是把 code 部署到測試環境部署並測試,測試沒問題就會部署到正式環境.</p><p>code 的穩定性那段由 CI 管理,部署過程是 CD,而部署有許多方法,但討論 CD 如何做需要從根本『環境』開使談起,要怎麼選擇你的運算資源這個問題很常見,aws 官方提供的講解如以下</p><ol><li><a href="https://wa.aws.amazon.com/wat.question.PERF_2.en.html" target="_blank" rel="noopener noreferrer">How do you select your compute solution?</a></li><li><a href="https://aws.amazon.com/tw/startups/start-building/how-to-choose-compute-option/" target="_blank" rel="noopener noreferrer">運算選項：虛擬機器、容器或是無伺服器？</a></li><li><a href="https://aws.amazon.com/products/compute/" target="_blank" rel="noopener noreferrer">運算資源分類</a></li></ol><p>這邊紀錄第二項,關於運算選項：虛擬機器、容器或是無伺服器？他給了三個應用案例</p><ol><li><p>AWS Lambda:想將專注力放在商業邏輯,且執行的任務沒有密集型運算或執行時間過長(超過 15min),又懶得管負載平衡、彈性擴展、聯網或編寫連接代碼 (例如用於使用者身分驗證、記錄日誌、擷取例外情況等) 之類的基礎設施問題,可以用 AWS Lambda,配合 S3,CloudFront,API Gateway,Amazon Cognito 和 AWS AppSync.</p></li><li><p>ECS or EKS: 單項任務需要密集型運算，或者執行時間超過 15 分鐘。它還可能需要跨越雲端和其他環境,可以考慮用 ECS,EKS.而 ECS 跟 EKS 怎麼選擇？如果您已經擁有 Kubernetes 的現有技能和偏好設定，則 EKS 是最好的選擇,如果不熟 EKS,就乖乖先用 ECS.</p></li><li><p>EC2: 巨型應用程式,願意完全存取底層基礎架構，以進行診斷和調整之類的操作,也熟悉 nginx 類,可以從 AWS Elastic Beanstalk 上大獲裨益，其將透過協助部署和佈建資源 (例如負載平衡、Auto Scaling 和運作狀態監控) 來加速在 EC2 上建立 Web 應用程式.</p></li></ol><p>基本上,對於工程師來說,你可能使用 VM,container(docker),k8s, 而要學哪一種,跟如何做到該環境的 CD 的這個問題,我的想法是先全學,之後工作遇到的時候比較好回答,要進一步了解也更快.</p><p>接著,來想一下一個封包怎麼由使用者端進到你的環境！這邊用一般 TLS 網路服務有使用憑證跟買網域的正常情況.</p><p>使用者 request 域名-&gt;DNS 解析域名對應的 IP-&gt; request 經過 CDN 到目的 ip -&gt;防火牆允許封包通過-&gt; Server 跟 client 做 TCP 三項交握 -&gt; TLS 憑證驗證交握,驗證 TLS 憑證的有效性 -&gt; web server 對封包加解密 -&gt; 應用程式處理封包中的請求-&gt;紀錄 log -&gt; 將回應封包加密後再通過 TLS 協議傳送回 client -&gt; 使用者 get response</p><p>簡單整理,IaC 常會需要管理以及設定以下東西:</p><ol><li><a href="#%E5%9F%9F%E5%90%8D">域名</a></li><li><a href="#%E6%86%91%E8%AD%89">憑證</a></li><li><a href="#%E7%B6%B2%E8%B7%AF%E5%8F%8A%E4%BC%BA%E6%9C%8D%E5%99%A8%E7%92%B0%E5%A2%83">網路及伺服器環境(防火牆,subnet 切分,路由表,gateway,CDN,security group 等等)</a></li><li><a href="#%E6%87%89%E7%94%A8%E7%A8%8B%E5%BC%8F%E9%83%A8%E7%BD%B2%E6%96%B9%E5%BC%8F">應用程式部署</a></li><li><a href="#%E7%9B%A3%E6%8E%A7%E7%A8%8B%E5%BC%8F">監控程式</a></li><li><a href="#%E6%97%A5%E8%AA%8C%E7%AE%A1%E7%90%86">日誌管理</a></li></ol><p>而 IaC 精神就是把這整個過程的建置,用程式的方式建立,也就是發生了什麼事情,怎麼建立的,都是用程式去控制,如果某段掛掉或被看你不順眼的工程師砍掉,可以迅速地用程式執行備援方案把這段掛掉的補上. 以下的小節,會去討論每階段 IaC 有哪些工具可以使用.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="域名">域名<a href="#域名" class="hash-link" aria-label="Direct link to 域名" title="Direct link to 域名">​</a></h3><p>DNS 記錄管理</p><ul><li><p>Terraform：Terraform 是一個基礎設施即代碼工具，支持管理多種域名註冊商和 DNS 解析服務商，例如 AWS Route 53、Cloudflare、GoDaddy 等。</p></li><li><p>Ansible：Ansible 是一個自動化 IT 工具，可以透過各種模組管理 DNS 記錄，支持的服務商包括 AWS Route 53、Cloudflare 等。</p></li><li><p>OctoDNS：OctoDNS 是一個由 GitHub 開發的開源 DNS 工具，支持自動化管理多種 DNS 解析服務商，例如 AWS Route 53、Cloudflare、Dyn、Google Cloud DNS 等。</p></li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="憑證">憑證<a href="#憑證" class="hash-link" aria-label="Direct link to 憑證" title="Direct link to 憑證">​</a></h3><p>將憑證的管理納入到設施即代碼 (Infrastructure as Code, IaC) 中。這樣做的好處是可以讓憑證的管理自動化、可追蹤，同時也可以確保憑證的使用符合政策和安全要求</p><ol><li>AWS Certificate Manager:如果你的服務有過 cloudfront,你的網站的憑證可以用 ACM 申請憑證,然後掛到 cloudfront 上面去,這樣你就可以用 https 連線,且 aws 會定期幫你 renew 憑證.</li><li>Certbot：Certbot 是一個由 Let&#x27;s Encrypt 提供的自動化憑證管理工具，支持自動化生成和更新 TLS/SSL 憑證。可以在你的 nginx 上面使用該套件省去換憑證困擾.</li></ol><h3 class="anchor anchorWithStickyNavbar_LWe7" id="網路及伺服器環境">網路及伺服器環境<a href="#網路及伺服器環境" class="hash-link" aria-label="Direct link to 網路及伺服器環境" title="Direct link to 網路及伺服器環境">​</a></h3><ol><li><p>AWS CloudFormation：AWS 提供的官方 IaC 工具，可用於創建和管理 AWS 資源，包括 VPC、子網、路由表、安全組等。</p></li><li><p>Terraform：是一款跨雲平台的 IaC 工具，支持多個雲端提供商和各種不同的資源類型。可以用來定義並管理 VPC、子網、路由表、安全組,開機器等。</p></li></ol><p>雖然 Ansible 可以做到類似的事情,不過因為它主要用於在多台主機之間進行配置、軟體安裝,的工具,跟 Terraform 比較的話 ,Terraform 的設定文件格式比較直觀，而且它可以幫助管理資源狀態，從而實現基礎設施的可靠性和可維護性</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="應用程式部署">應用程式部署<a href="#應用程式部署" class="hash-link" aria-label="Direct link to 應用程式部署" title="Direct link to 應用程式部署">​</a></h3><p>自動化部署應用程式到目標伺服器或容器，並確保應用程式配置和運行環境一致。主要有四大套件 Puppet、SaltStack、Chef 和 Ansible.</p><p>因為看 104 裡面最常會問的就是 ansible,所以建議先從 Ansible 看．</p><p>Ansible：</p><ul><li>使用 YAML 編寫，具有高可讀性和易於學習。</li><li>以推送模式工作，無需安裝代理程序。</li><li>適用於各種規模的基礎設施，易於上手。</li><li>與其他工具集成良好，廣泛應用於自動化部署和持續集成/持續交付（CI/CD）。</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="監控程式">監控程式<a href="#監控程式" class="hash-link" aria-label="Direct link to 監控程式" title="Direct link to 監控程式">​</a></h3><p>在監控 VM 上面的數據,用 Zabbix 或 Prometheus 可以達到同功能,不過在監控 Kubernetes 和 Docker，會比較推薦使用 Prometheus.</p><p>在使用 Zabbix 時,因為他圖不太好看,所以會搭配其他套軟體,ex.Grafana 可以將 zabbix 資料匯入他的介面,做圖表美化.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="日誌管理">日誌管理<a href="#日誌管理" class="hash-link" aria-label="Direct link to 日誌管理" title="Direct link to 日誌管理">​</a></h3><p>使用 IaC 工具，可以配置和整合日誌管理工具，如 Amazon CloudWatch Logs 或 ELK Stack（Elasticsearch、Logstash、Kibana），以收集、分析和儲存應用程式和基礎設施的日誌。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="為什麼要學-iac">為什麼要學 IaC<a href="#為什麼要學-iac" class="hash-link" aria-label="Direct link to 為什麼要學 IaC" title="Direct link to 為什麼要學 IaC">​</a></h2><p>現實問題是,不管是面試 DevOps 還是 SRE,每家公司去面試都會先問你用過的 IaC 工具,在找工作被問到不會就是扣分,有些人的第一間公司就把這些工具用遍了,有些人則不是,所以如果自認沒有比別人有更多的幸運,天份或背景,那能做的就是比別人有更多的耐心跟努力.</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/ia-c">IaC</a></li></ul></div></footer></article><div id="disqus_thread"></div><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><meta itemprop="image" content="https://github.com/suyuying.png"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/blog/2023/04/30/IaC/ansible/ansible-basic-introduction">Basic introduction of ansible</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2023-04-30T00:00:00.000Z" itemprop="datePublished">April 30, 2023</time> · <!-- -->21 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/suyuying" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://github.com/suyuying.png" alt="zaxro"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/suyuying" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">zaxro</span></a></div><small class="avatar__subtitle" itemprop="description">Life is too short to live someone else&#x27;s dream</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>這邊放學習經驗,未來工作中如果發現有其他做法,或者發現觀念有錯，都會滾動式修改,請多多見諒～</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="what-is-ansible">what is ansible<a href="#what-is-ansible" class="hash-link" aria-label="Direct link to what is ansible" title="Direct link to what is ansible">​</a></h2><p>ansible 是組態管理工具 Configuration management Tool ,含有自動化工具,配置系統、部署軟件和編排更高級的 IT 任務，例如持續部署或零停機滾動更新.</p><p>使用 OpenSSH 去管理機器.支援 Kerberos、LDAP 和其他集中式身份驗證管理系統.</p><p>Ansible 是 Python 陣營的組態管理工具,不用幫每台機器 (instance) 預載 agent ，只要有 SSH 和 Python 就可以執行.</p><p>官網的資訊很多,對於初學者來說,最重要的是<a href="https://docs.ansible.com/ansible/latest/getting_started/index.html" target="_blank" rel="noopener noreferrer">Getting started with Ansible</a>以及其底下到小章節,這邊主要是講基礎觀念！</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="ansible-concepts">Ansible concepts<a href="#ansible-concepts" class="hash-link" aria-label="Direct link to Ansible concepts" title="Direct link to Ansible concepts">​</a></h2><div class="theme-admonition theme-admonition-tip alert alert--success admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_S0QG"><p>基本上,RD 的習慣會是需要的工具先上網找輪子,找不到的自己寫,IT 人員的習慣就是找輪子,並透過輪子寫好的的設定檔去管理任何事情,所以要習慣查官網資料才行,也要了解一隻程式總共有哪些設定檔,及設定檔可能出現的位置！</p></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="環境名詞定義">環境名詞定義<a href="#環境名詞定義" class="hash-link" aria-label="Direct link to 環境名詞定義" title="Direct link to 環境名詞定義">​</a></h3><p>基本環境需要要有以下幾點</p><ul><li><p>控制節點 (Control node)：Ansible 控制主機端,安裝有 Ansible 的系統。您可以在控制節點上執行 Ansible 指令，例如 ansible 或 ansible-inventory,主要透過 openssh 到 Managed node.</p></li><li><p>被管理節點 (Managed node)：Ansible 客戶端,由 Ansible 控制主機端所控制的遠端系統或主機,透過 Control node 以 SSH 方式近來這台機器。</p></li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="文檔名詞定義">文檔名詞定義<a href="#文檔名詞定義" class="hash-link" aria-label="Direct link to 文檔名詞定義" title="Direct link to 文檔名詞定義">​</a></h3><ul><li><p>庫存清單 (Inventory)：一個按邏輯分類的被管理節點列表。您在控制節點上建立庫存清單，以便描述主機部署情況給 Ansible,舉例來說,你的一個服務可能由多台機器組成,Inventory 方便你一次操作這群機器們.</p></li><li><p>Playbooks: 一個 playbook 可以由一到多個 plays 組成,將管理節點（主機）對應至任務。Playbooks 包含變數、角色和任務的有序列表，</p><ul><li><p>Plays: Plays 是 Ansible 執行的主要上下文，這個 playbook 物件將被管理的節點（主機）對應至任務。Play 包含變數、角色和任務的有序列表，可以重複執行。</p></li><li><p>Roles: Roles 是一種有限的可重複使用的 Ansible 工具,可以給多個 playbook 重複用</p></li><li><p>Tasks: 會套用於被管理主機的&quot;操作&quot;。</p></li></ul></li><li><p>Handlers: Handler 是 Task 的一種特殊形式，只有在先前的 Task 發出&quot;changed&quot;狀態的通知時才會執行。</p></li><li><p>Modules: Ansible 提供的 function</p></li><li><p>Plugins: 插件是擴展 Ansible 核心功能的代碼片段，它們可以控制如何連接到受管節點（連接插件），操作數據（過濾插件）甚至控制控制台中顯示的內容（回調插件）</p></li><li><p>Collections:一種以 Playbook、角色、模組和插件等形式分發 Ansible 內容的格式。您可以通過 Ansible Galaxy 安裝和使用集合。</p></li><li><p>AAP: Ansible 自動化平台的簡稱。這是一種包含企業級功能的產品，並整合了 Ansible 生態系統中的許多工具：ansible-core、awx、galaxyNG 等等。</p></li></ul></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/ansible">Ansible</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/ia-c">IaC</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about Basic introduction of ansible" href="/blog/2023/04/30/IaC/ansible/ansible-basic-introduction"><b>Read More</b></a></div></footer></article><div id="disqus_thread"></div><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><meta itemprop="image" content="https://github.com/suyuying.png"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/blog/2023/04/27/linux-server/linux-default-use-of-folder">Common folder and their uses in Linux</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2023-04-27T00:00:00.000Z" itemprop="datePublished">April 27, 2023</time> · <!-- -->5 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/suyuying" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://github.com/suyuying.png" alt="zaxro"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/suyuying" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">zaxro</span></a></div><small class="avatar__subtitle" itemprop="description">Life is too short to live someone else&#x27;s dream</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><h2 class="anchor anchorWithStickyNavbar_LWe7" id="purpose-of-each-folder">purpose of each folder<a href="#purpose-of-each-folder" class="hash-link" aria-label="Direct link to purpose of each folder" title="Direct link to purpose of each folder">​</a></h2><ul><li>/（根目錄）：Linux 文件系統的起點，所有的目錄和文件都是以根目錄作為參照點。</li><li>/bin：包含一些常用的系統二進位執行檔（executable），如 ls、cp 等等。</li><li>/boot：系統啟動時使用的核心檔案和啟動載入器（bootloader）。</li><li>/dev：包含一些裝置檔案（device files），如硬盤、鍵盤、滑鼠等等。</li><li>/etc：系統全局的配置文件目錄，包含系統和應用程序的配置文件。</li><li>/home：用戶的家目錄，即每個用戶的個人資料目錄。</li><li>/lib：庫文件目錄，包含系統和應用程序所需的庫文件。</li><li>/mnt：用戶暫時掛載的文件系統目錄，通常用於掛載外部儲存設備，如 USB 隨身碟、CD-ROM 等等。</li><li>/opt：存放可選的應用程序目錄，通常包含第三方應用程序和軟件。</li><li>/proc：虛擬文件系統目錄，允許操作系統內核和進程的運行狀態。</li><li>/root：root 用戶的家目錄。</li><li>/run：系統啟動後，某些程序運行時使用的暫存目錄，包括 PID 文件、掛載點等等。</li><li>/sbin：包含一些系統管理用途的二進位執行檔，僅限 root 用戶使用。</li><li>/srv：存放網路服務（如 FTP、HTTP）的數據目錄。</li><li>/sys：系統文件系統，包含系統硬件和設備的信息。</li><li>/tmp：用於存放臨時文件的目錄，一般文件都會在系統重新啟動後自動清除。</li><li>/usr：用於存放共享的、只讀的和不經常變動的文件，包括程序和庫文件等等。</li><li>/var：存放經常變動的文件，包括日誌文件、緩存和臨時文件,某些應用程序和服務的數據庫以及其他各種程式運行時產生的數據文件等。</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="basic-concepts">Basic concepts<a href="#basic-concepts" class="hash-link" aria-label="Direct link to Basic concepts" title="Direct link to Basic concepts">​</a></h3><p>單純看上面的各資料夾用處一定還是會覺得很陌生,以下用常見例子幫助了解</p><ol><li>用 yum 安裝 mysql 之後,請問他的數據位置會在哪個資料夾? 設定檔會在哪? 其他？</li></ol><ul><li>數據文件會放在/var/lib 底下,以 mariadb 為例,到/var/lib/mysql 底下會看到各數據庫的數據(每個 database 一個 folder)還有 crash recovery 時用於儲存 metadata 的 log 檔案等,這是因為/var 規劃是放數據文件跟日誌文件</li><li>設定檔在/etc 底下,依據系統,centos 可能在/etc/my.cnf 或/etc/mysql/my.cnf,不過基本上都會在/etc,因為/etc 規劃放系統或應用程序的 config 的,注意 my.cnf 會用!includedir /etc/my.cnf.d 去進一步包設定檔,需要 cnf 為結尾.</li><li>pid 文件一般位于 /var/run/mysqld/mysqld.pid 或 /var/lib/mysql/{hostname}.pid</li><li>日誌會在/var/log/mysql 底下.</li><li>共用文件在 /usr/share/mysql/ 中存放的是 MySQL 的一些共用文件，其中包括：<ol><li>公用的語言文件和字符集文件。</li><li>公用的系統表空間文件。</li><li>公用的插件庫文件。</li><li>公用的文檔和示例文件。</li></ol></li></ul><ol start="2"><li>docker 數據文件跟設定檔？</li></ol><ul><li>數據文件會在/var/lib/docker 底下,依照 container ID 放置(另外用 bind mount 掛的不算,複習一下 bind mount 建立指令<code>docker run -d --name my_container \ -v /path/on/host:/path/in/container \my_image</code>)</li><li>設定檔在/etc/docker 底下,預設只有一隻 key.json,也可以加入其他設定,例如/etc/docker/daemon.json 可以對 log 格式的 size 跟輪詢做設定.</li></ul></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/linux">linux</a></li></ul></div></footer></article><div id="disqus_thread"></div><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><meta itemprop="image" content="https://github.com/suyuying.png"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/blog/2023/04/26/Aws/aws-ec2-elb-setting">aws EC2 and ELB setting introduction</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2023-04-26T00:00:00.000Z" itemprop="datePublished">April 26, 2023</time> · <!-- -->14 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/suyuying" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://github.com/suyuying.png" alt="zaxro"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/suyuying" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">zaxro</span></a></div><small class="avatar__subtitle" itemprop="description">Life is too short to live someone else&#x27;s dream</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>這邊接續<a href="/docs/Aws/2023-04-11-aws-vpc-setting">AWS 網路篇</a>的 lab.</p><p>目標:Region 內建立 VPC,並使用 elb 將流量導到兩個不同 AZ 中的 web server,避免因為單一 AZ 故障導致的服務中斷.日常管理透過堡壘機進入 web server 做管理.</p><div class="theme-admonition theme-admonition-tip alert alert--success admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_S0QG"><p>基本上 EC2 跟 ELB 設定相關依序:</p><ol><li><a href="#%E5%BB%BA%E7%AB%8B-keypair-%E5%85%AC%E7%A7%81%E9%91%B0">建立 KeyPair 公私鑰</a></li><li><a href="#ec2-for-web-server-and-bastion-server">建立 EC2 for web server and bastion server</a></li><li><a href="#%E8%A8%AD%E5%AE%9A%E8%B7%B3%E6%9D%BF%E6%A9%9F-ssh-%E9%80%A3%E7%B7%9A">設定跳板機 ssh 連線</a></li><li><a href="#%E5%BB%BA%E7%AB%8B-target-group">建立 target group</a></li><li><a href="#%E5%BB%BA%E7%AB%8B-elb">建立 ELB</a></li><li><a href="#%E5%95%9F-http-%E4%BC%BA%E6%9C%8D%E5%99%A8">啟 HTTP 伺服器</a></li><li><a href="#%E8%A8%AD%E5%AE%9A-forward-%E6%93%8D%E4%BD%9C">設定-forward-操作</a></li><li><a href="#%E8%A8%AD%E5%AE%9A-https-%E5%81%9A-listener">設定 HTTPS 做 listener</a></li><li>DONe！</li></ol></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="aws-ec2-introduction">AWS EC2 introduction<a href="#aws-ec2-introduction" class="hash-link" aria-label="Direct link to AWS EC2 introduction" title="Direct link to AWS EC2 introduction">​</a></h2><p>是 Amazon Web Services（AWS）提供的一種基礎架構即服務（IaaS），它允許用戶在 AWS 雲中啟動和管理虛擬機器（VM），稱為 EC2 實例。使用 EC2，用戶可以獲得可調整的計算資源，包括虛擬機器、存儲、網路帶寬和安全性。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="bastion-server">Bastion server<a href="#bastion-server" class="hash-link" aria-label="Direct link to Bastion server" title="Direct link to Bastion server">​</a></h3><p>堡壘機的建立用來管控跟紀錄使用者操作,透過本機的私有金鑰以及對應放在堡壘機的公有金鑰連線,連線到堡壘機後,再透過放在堡壘機的私鑰連線到對應在內部資源的公鑰做機台管理,另外,也可以透過 multi-hop 方式,在私鑰只放在本機的情況下,透過堡壘機跳到目標管理機器中.</p><p>本篇會將 bastion server 放在 public subnet 底下,會有對外 ip,透過 Igw 跟外界溝通.</p><div class="theme-admonition theme-admonition-info alert alert--info admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_S0QG"><p>mac,linux,windows 10 以上主要支援的金鑰檔案格式為<!-- -->*<!-- -->.pem.</p><p>windows 9 以前是支援 ppk 格式.</p></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="aws-elb-introduction">AWS ELB introduction<a href="#aws-elb-introduction" class="hash-link" aria-label="Direct link to AWS ELB introduction" title="Direct link to AWS ELB introduction">​</a></h2><p>主要負責流量的反向代理,將流量依據使用者設定導到各台伺服器(Target group),功用整理如下:</p><ol><li>分散眾多 request</li><li>處理 SSL 加密連線</li><li>修復請求錯誤(應付 400 Bad request 等)</li></ol><p>不過這幾件事情其實 Nginx 都做得到,另外為避免 Nginx 暴露 IP 被打爆,前面通常也會接其他家 CDN,這樣相比之下用 Nginx+CDN 也是個不錯選項.</p><p>因此 Nginx+CDN 跟雲服務商的 load balancer 如何選擇？ 使用雲服務商提供的 Load Balancer 的可用性是較高的,且可以應付流量大小變化,個人覺得適用在搶票系統以及其他流量會瞬間暴衝的公司,如果公司流量穩定的話,使用 Nginx+CDN 會是比較好的選項.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="aws-提供-elb-的選項">AWS 提供 ELB 的選項<a href="#aws-提供-elb-的選項" class="hash-link" aria-label="Direct link to AWS 提供 ELB 的選項" title="Direct link to AWS 提供 ELB 的選項">​</a></h3><p>aws 提供的 load balancer 由 Elastic Load Balancing(ELB)所提供,至 2023/4/22 共有 4 種 ELB,這邊提供<a href="https://aws.amazon.com/elasticloadbalancing/features/" target="_blank" rel="noopener noreferrer">官方把較連結</a></p><ul><li>Application Load Balancer(ALB):主要用於處理 HTTP/HTTPS 流量(Layer 7)</li><li>Network Load Balancer(NLB):主要用於處理 TCP、TLS 和 UDP 流量(Layer 4)</li><li>Classic Load Balancer(CLB):舊版,很少用到</li><li>Gateway Load Balancer(GLB): 主要用於處理 NAT 和防火牆等網絡服務，能夠將進入 VPC 的流量分發到多個目的地(Layer 3 Gateway + Layer 4 Load Balancing )</li></ul><p>ALB 主要用於第 7 層 Load Balancer,主要轉導 protocol: HTTP, HTTPS,基本上就跟 Nginx 差不多,目前了解,差別在沒有偵測來源 IP 城市(nginx geoip)</p><p>會設定的內容:</p><ul><li>Availability Zone:指定的 VPC Region 跟 ELB 需為同一 Region,該 Region 底下 AZ 的都可用,選擇的 subnet 需要有連接 Igw(route tale 也要有),不然會失效.</li><li>target group: 主要有對內跟對外兩種設定,如果指定了 VPC 中的目標，那麼就是對內的設定；如果指定了 Public IP 或 DNS，那麼就是對外的設定。對內要設定 listener 選擇接收協議,以及 request 怎麼分散到各 web server.</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="lab">lab<a href="#lab" class="hash-link" aria-label="Direct link to lab" title="Direct link to lab">​</a></h2><ol><li><a href="#%E5%BB%BA%E7%AB%8B-keypair-%E5%85%AC%E7%A7%81%E9%91%B0">建立 KeyPair 公私鑰</a></li><li><a href="#ec2-for-web-server-and-bastion-server">建立 EC2 for web server and bastion server</a></li><li><a href="#%E8%A8%AD%E5%AE%9A%E8%B7%B3%E6%9D%BF%E6%A9%9F-ssh-%E9%80%A3%E7%B7%9A">設定跳板機 ssh 連線</a></li><li><a href="#%E5%BB%BA%E7%AB%8B-target-group">建立 target group</a></li><li><a href="#%E5%BB%BA%E7%AB%8B-elb">建立 ELB</a></li><li><a href="#%E5%95%9F-http-%E4%BC%BA%E6%9C%8D%E5%99%A8">啟 HTTP 伺服器</a></li><li><a href="#%E8%A8%AD%E5%AE%9A-forward-%E6%93%8D%E4%BD%9C">設定-forward-操作</a></li><li><a href="#%E8%A8%AD%E5%AE%9A-https-%E5%81%9A-listener">設定 HTTPS 做 listener</a></li><li>DONe！</li></ol><h3 class="anchor anchorWithStickyNavbar_LWe7" id="建立-keypair-公私鑰">建立 KeyPair 公私鑰<a href="#建立-keypair-公私鑰" class="hash-link" aria-label="Direct link to 建立 KeyPair 公私鑰" title="Direct link to 建立 KeyPair 公私鑰">​</a></h3><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">EC2 service -&gt; Network &amp; Security -&gt; Key Pairs -&gt;Create Key Pairs-&gt; choose RSA , .pem(For use with OpenSSH) -&gt;download .pem file</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>如果不小心把載到本機的.pem 檔私鑰刪除,先前使用的舊金鑰就都要作廢了ＱＱ 沒有恢復方法！</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="ec2-for-web-server-and-bastion-server">EC2 for web server and bastion server<a href="#ec2-for-web-server-and-bastion-server" class="hash-link" aria-label="Direct link to EC2 for web server and bastion server" title="Direct link to EC2 for web server and bastion server">​</a></h3><p>bastion server 建立在 public subnet,web server 建立在 private subnet 上.</p><p>web server 其實也可以放在 public subnet,讓使用者直接透過 EIP 進來,不過如果遇到 ddos 攻擊,很容易 web server 就掛了,所以最好前面要有 elb 或者 cdn 這一層.最後,如果 web server 不對外,只靠 elb 之類轉進來,遇到雲服務廠商的 elb 掛掉,就會要花比較多時間把 web server 放回去對外就是.</p><p>security group 部分,注意他 associate 在 VPC 上,VPC 是分 Region 的,所以找不到你先前建立的 security group 的時候,去確認 Region 跟 VPC 是否有選對位置.</p><p>bastion server 至少需要允許你的 ip 可以 ssh 連入,且 outbound 可以到所有內網需管控機器(10.0.0.0/16),且要有對外 IP.</p><p>web server 因為規劃放在 private subnet 網段,只要 inbound 讓所有內網可以連入(10.0.0.0/16)就好,outbound 則考慮之後會串後端,可以用(10.0.0.0/16),基本上範圍可以在限縮.</p><p>規劃用 elb 連到內部兩台 web server,兩台 subnet 都用 private subnet</p><p>操作：</p><p>EC2 -&gt;instances -&gt; launch instances -&gt;Name(product-resource-purpose-region)ex. ford-ec2-bastion-uw1 -&gt; app and os image(my ami or aws market ,or community AMIs) -&gt; instance type(choose cpu ,memory) -&gt;choose key pair for login-&gt; choose ur vpc,subnet, enable auto-assign public ip -&gt; select security group(default and bastion)-&gt; DONe</p><div class="theme-admonition theme-admonition-tip alert alert--success admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_S0QG"><p>注意事項:我自己在設定過程中有時候按一按就會忘掉 Network Settings 那部份,所以提醒開 EC2 跟線上問題排除一樣要注意</p><ol><li>硬體狀態(cpu,記憶體,硬碟)</li><li>網路狀態(防火牆,及網路互通狀況)</li></ol></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="設定跳板機-ssh-連線">設定跳板機 ssh 連線<a href="#設定跳板機-ssh-連線" class="hash-link" aria-label="Direct link to 設定跳板機 ssh 連線" title="Direct link to 設定跳板機 ssh 連線">​</a></h3><p>指令如下,可以用-i 指定私鑰檔案位置</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">ssh -i &quot;ford.pem&quot; ec2-user@77.77.77.77</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>也可以到~/.ssh/config 裡面修改資料(可以用 v 開啟視覺化模式,移動光標選擇欲複製的範圍。按下 y 複製選取的文字。移動光標到欲貼上的位置。按下 p 貼上複製的文字。)</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Host            ford-bastion</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">HostName        77.77.77.77</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Port            22</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">User            ec2-user</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">IdentityFile    ~/.ssh/ford.pem</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>以上設定好之後,第一次連線會出現以下訊息.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">ED25519 key fingerprint is SHA256:7PkkXMF4y2j71d4HTy4qxVRWm77eBQtT73mf8Mf5MH4.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">This key is not known by any other names</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Are you sure you want to continue connecting (yes/no/[fingerprint])?</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>這是因為 ssh client 第一次連線 ssh server 時,他會需要使用者去確認是不是要連這台 server,如果 yes,ssh client 端就會把 ssh server 的公鑰用 加到本地~/.ssh/known_hosts 裡面,下次連線會去該檔案驗證是否是已知的 hosts 及公鑰是否符合,如此一來就可以避免中間人攻擊等安全問題.</p><div class="language-jsx codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">~/.ssh/known_hosts</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-jsx codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token number" style="color:#36acaa">54.151</span><span class="token number" style="color:#36acaa">.73</span><span class="token number" style="color:#36acaa">.235</span><span class="token plain"> ecdsa</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">sha2</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">nistp256 </span><span class="token maybe-class-name">AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBHX9fQvFIXuJg3LF8777</span><span class="token operator" style="color:#393A34">+</span><span class="token plain">51qzM7FymrnPoDrYX1Ezr083gutn</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">5NZkkslRs8mL</span><span class="token operator" style="color:#393A34">+</span><span class="token plain">nSEOwcwJQfy</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">s4t7RK1dYQu4</span><span class="token operator" style="color:#393A34">=</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>multi-hop 設定檔,用以把透過 bastion server,連到 private subnet 的 web server.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Host            ford-bastion</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">HostName        13.52.247.248</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Port            22</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">User            ec2-user</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">IdentityFile    ~/.ssh/ford.pem</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Host web01</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Hostname 10.0.42.235 # (網頁伺服器 1 的私有 IP)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">User ec2-user</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">IdentityFile ~/.ssh/ford.pem</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ProxyCommand ssh ford-bastion -W %h:%p</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Host web02</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Hostname 10.0.56.218 # (網頁伺服器 2 的私有 IP)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">User ec2-user</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">IdentityFile ~/.ssh/ford.pem</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ProxyCommand ssh ford-bastion -W %h:%p</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="建立-target-group">建立 target group<a href="#建立-target-group" class="hash-link" aria-label="Direct link to 建立 target group" title="Direct link to 建立 target group">​</a></h3><p>操作:</p><p>EC2 -&gt; Load Balancing -&gt; Target Groups -&gt; 這邊適用 EC2 起的服務所以選 instance -&gt; input group name -&gt; input HTTP and 3000 port -&gt; choose VPC -&gt; choose instance ID(Ports for the selected instances)把流量導到指定位置的 3000 port.</p><p>這邊設定意思是把 ELB 把 443 流量解密後送到 port 3000 上得 web server,然後依據流量到這兩台 EC2.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="建立-elb">建立 ELB<a href="#建立-elb" class="hash-link" aria-label="Direct link to 建立 ELB" title="Direct link to 建立 ELB">​</a></h3><p>因為是會面向網路的 web server,需要 VPC 及 security group 支援,要做 load balance 需要兩個 AZ 以上.</p><p>封包傳遞過程(到 EC2 為例):</p><p>request: Client -&gt; Internet -&gt; Elb -&gt; Igw -&gt; public subnet(查 route table) -&gt; Target Group -&gt; EC2</p><p>response: EC2 -&gt; public subnet(查 route table) -&gt;Igw -&gt; Internet -&gt; Client</p><p>以上面過程知道,要透過 elb 連到 private group 裡的 EC2,中間需要符合幾格條件</p><ol><li>public subnet- subnet 需要有 Igw 讓封包可以進來,且 route table 有 desination 0.0.0.0/0 透過 Igw 轉導,並可以識別 local</li><li>security group- 機器的 security group 要可以讓外界連入,把流量從 Internet 經 ELB 到 Igw -&gt; public subnet,再透過 public subnet 的 router table 查詢到 private subnet 中的 web server.</li></ol><p>本章用 web server,只用 HTTP/HTTPS 協議,所以用 ALB 就行,另外 ELB 是有分 Region 的.</p><p>操作:</p><p>EC2 -&gt; Load Balancing -&gt; Load Balancers -&gt; input Load balancer name -&gt; scheme: choose internet-facing-&gt; IPV4-&gt;choose VPC -&gt; choose Mappings of Two AZ in same Region-&gt; choose security group -&gt;choose Listener and target.</p><div class="theme-admonition theme-admonition-info alert alert--info admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_S0QG"><ol><li>scheme 部分有兩個選項:</li></ol><ul><li>Internet-facing：如果我們要從外網請求的話就要選擇這個選項，記得要到 public subnet,這樣 ELB 才能透過外網的 Igw 近來</li><li>Internal：這會讓這個 alb 只能在內網使用，就無所謂用 public subnet 還是 private subnet 了。</li></ul><ol start="2"><li>Listener 部分:可以選 HTTP or HTTPS,如果選 HTTPS 就要選你的憑證要用 AWS Certificate Manager(ACM),IAM,匯入憑證等方式</li></ol></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="啟-http-伺服器">啟 HTTP 伺服器<a href="#啟-http-伺服器" class="hash-link" aria-label="Direct link to 啟 HTTP 伺服器" title="Direct link to 啟 HTTP 伺服器">​</a></h3><p>在連入的目錄底下建立 index.html,並用以下指令起服務.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">python3 -m http.server 3000</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="設定-forward-操作">設定 forward 操作<a href="#設定-forward-操作" class="hash-link" aria-label="Direct link to 設定 forward 操作" title="Direct link to 設定 forward 操作">​</a></h3><p>ELB 設定後 listener 只有基本的 rule,目前只有一條 If (all match)Request is not otherwise routed to target group.</p><p>正常使用情況會是: 你自己的域名(ex. modontou.don69.store)設定到該 ELB,再透過 ELB 依據請求的設定,把請求轉到 Target Group.</p><p>可以做的設定:</p><ul><li>主機標頭（Host header）：域名</li><li>路徑（Path）：域名後面帶的路徑，ex. /channelHandle</li><li>HTTP 標頭（Http header）：就 http header</li><li>Http 請求方法（Http request methed）：GET、POST…….</li><li>查詢字串（Query string）：域名帶進去的參數，ex. /?test=123</li><li>來源 IP（Source IP）：Client 端的 IP</li></ul><p>Action 部分有三個:</p><ol><li>Forward to: 轉寄,會把符合條件的請求導向設定的 target group，可以設定多個 target group 並且可以設定權重</li><li>Redirect to: 重導向,符合條件的域名轉導到設定的域名(HTTP status code: 301,302)</li><li>Return fixed response: 固定回傳,符合條件的域名都回覆設定的 http code 或是設定的內文</li></ol><p>Group-level stickiness: 意思是在 load balance 過程中,啟用會話保持機制,主要是讓同一 client 透過在 client&#x27;s browser 端設定 cookie 給 ELB 做辨別,讓 client 端可以持續跟同一台 backend server 做互動.cookie 預設一天到期.</p><p>操作:</p><p>EC2 -&gt; Load Balancing -&gt; yourLoadBalancer -&gt; Listeners -&gt; click 1 rule(基本上這時候你只有一個 rule)-&gt; Manage rules -&gt; Edit rules -&gt;選 Host Header 加入域名,Add action 部分用 Forward to 你的 Target group.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="設定-https-做-listener">設定 HTTPS 做 listener<a href="#設定-https-做-listener" class="hash-link" aria-label="Direct link to 設定 HTTPS 做 listener" title="Direct link to 設定 HTTPS 做 listener">​</a></h3><p>這個要在 ELB 加上 HTTPS 的 listener. 另外 ACM 那邊要加個 wild card 憑證綁你的域名.</p><div class="theme-admonition theme-admonition-tip alert alert--success admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_S0QG"><p>ACM 申請要用 wildcard certificate 在申請時一定要用<!-- -->*<!-- -->
<!-- -->*<!-- -->.don7.store</p><p>因為加解密發生在 ELB,所以 target group 那邊 listen 的 port 就是你前端起服務的 port 就搞定！不用另外設定成 HTTPS.</p></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="小結">小結<a href="#小結" class="hash-link" aria-label="Direct link to 小結" title="Direct link to 小結">​</a></h2><p>基本的 EC2 跟 AWS internet 相關設定到這邊,接下來是 RDS,然後把後端程式透過 IaC 方式部署,不要再透過 UI 點擊.</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/aws">AWS</a></li></ul></div></footer></article><div id="disqus_thread"></div><nav class="pagination-nav" aria-label="Blog list page navigation"><a class="pagination-nav__link pagination-nav__link--next" href="/blog/page/2"><div class="pagination-nav__label">Older Entries</div></a></nav></main></div></div></div><footer class="font-sans container-fluid bg-gray-900 text-stone-200 pt-6 footer--dark"><div style="transform:translateX(-100%)" class="fixed bottom-0 left-0 h-1 w-full bg-indigo-600 backdrop-blur-3xl transition-transform duration-300 text-right text-white text-sm"></div><div class="container container-fluid"><div class="row footer__links mb-0"><div class="flex flex-wrap flex-col mb-2 w-1/3 items-baseline"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs/intro">Tutorial</a></li></ul></div><div class="flex flex-wrap flex-col mb-2 w-1/3 items-baseline"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Stack Overflow<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://discordapp.com/invite/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="flex flex-wrap flex-col mb-2 w-1/3 items-baseline"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/suyuying" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2023 My Project, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.4f00459b.js"></script>
<script src="/assets/js/main.f3a13247.js"></script>
</body>
</html>